<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focal X - Node.js Bootcamp: Lecture 17 </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .footer {
            padding-top: 30px;
        }

        .footer a {
            color: black;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .coach {
            background-color: white;
            width: 80px;
            border-radius: 0 0 50% 0;
            color: black;
            padding: 10px;
            position: absolute;
            left: 0;
            top: 0;
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
            height: 65vh;
        }
        
        .lecture-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }
        
        .interactive-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }
        
        h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            font-size: 1.5rem;
        }
        
        h3 {
            color: #2980b9;
            margin: 20px 0 12px;
            font-size: 1.2rem;
        }
        
        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 12px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 12px 0;
            font-size: 0.9rem;
        }
        
        code {
            font-family: 'Fira Code', monospace;
        }
        
        .question {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin: 12px 0;
        }
        
        .option {
            padding: 10px;
            background: #e8f4fc;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 0.9rem;
        }
        
        .option:hover {
            background: #d1e9fa;
        }
        
        .correct {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }
        
        .incorrect {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
        }
        
        .task {
            background: #fff3cd;
            padding: 12px;
            border-left: 5px solid #ffc107;
            margin: 15px 0;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
            margin-top: 8px;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .result {
            margin-top: 12px;
            padding: 12px;
            border-radius: 5px;
            display: none;
            font-size: 0.9rem;
        }
        
        .search-task {
            background: #e7f5e9;
            padding: 12px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 5px solid #28a745;
            font-size: 0.9rem;
        }
        
        .tabs {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 8px 15px;
            cursor: pointer;
            background: #f1f1f1;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .tab.active {
            background: #6f42c1;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            font-size: 0.9rem;
        }
        
        .comparison-table th, .comparison-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        
        .comparison-table th {
            background-color: #3498db;
            color: white;
        }
        
        .comparison-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        @media (max-width: 900px) {
            .content {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .lecture-content, .interactive-section {
                height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <p class="coach">Moones Mezher</p>
        <header>
            <h1 id="lecture-title">Focal X - Node.js Bootcamp</h1>
            <p class="subtitle" id="lecture-subtitle">Node</p>
        </header>
        
        <div class="content">
            <div class="lecture-content">
                <h2>Lecture Content</h2>
                <div id="tabs-container"></div>
                <div id="tab-content-container"></div>
            </div>
            
            <div class="interactive-section">
                <h2>Interactive Questions & Tasks</h2>
                <div id="questions-container"></div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2025 <a rel="noopener" href="https://focal-x.com/" target="_blank">Focal X</a> All Right Reserved</p>
    </footer>

    <script>
        // ==================== CONFIGURATION ====================
        // Update these arrays to change the content of your lecture
        
        // Lecture metadata
        const lectureConfig = {
            title: "Focal X - Node.js Bootcamp",
            subtitle: "ExpressJS (Advanced)"
        };
        
       // Lecture content organized by tabs
const lectureContent = [
    {
        tabTitle: "Last Lesson",
        title: "Last Lesson Recap",
        content: `/*
1- Solve Task 5
2- Resturant Example
*/`
    },
    {
        tabTitle: "CRUD Operations & Validation",
        title: "Building Robust CRUD APIs",
        content: `/*
Complete CRUD Implementation with:
• Input validation
• Error handling with try-catch
• Proper status codes
• Data sanitization
*/

let users = [
    { id: 1, name: "moones", age: 21, email: "moones@example.com" },
    { id: 2, name: "rami", age: 31, email: "rami@example.com" },
    { id: 3, name: "dana", age: 41, email: "dana@example.com" }
];

// Input validation middleware
const validateUser = (req, res, next) => {
    try {
        const { name, age, email } = req.body;
        const errors = [];

        if (!name || typeof name !== 'string' || name.length < 2) {
            errors.push('Name must be a string with at least 2 characters');
        }

        if (!age || typeof age !== 'number' || age < 18 || age > 120) {
            errors.push('Age must be a number between 18 and 120');
        }

        if (!email || !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email)) {
            errors.push('Valid email is required');
        }

        if (errors.length > 0) {
            return res.status(400).json({ 
                success: false,
                error: 'Validation failed', 
                details: errors 
            });
        }

        next();
    } catch (error) {
        res.status(500).json({
            success: false,
            error: 'Validation error'
        });
    }
};

// GET all users with filtering and error handling
app.get('/api/users', async (req, res) => {
    try {
        const { minAge, maxAge, search } = req.query;
        let filteredUsers = [...users];

        if (minAge) {
            filteredUsers = filteredUsers.filter(user => user.age >= parseInt(minAge));
        }

        if (maxAge) {
            filteredUsers = filteredUsers.filter(user => user.age <= parseInt(maxAge));
        }

        if (search) {
            filteredUsers = filteredUsers.filter(user => 
                user.name.toLowerCase().includes(search.toLowerCase())
            );
        }

        res.json({
            success: true,
            count: filteredUsers.length,
            data: filteredUsers
        });
    } catch (error) {
        console.error('Get users error:', error);
        res.status(500).json({
            success: false,
            error: 'Failed to fetch users'
        });
    }
});

// POST create user with validation
app.post('/api/users', validateUser, async (req, res) => {
    try {
        const { name, age, email } = req.body;
        
        // Check for duplicate email
        const existingUser = users.find(u => u.email === email);
        if (existingUser) {
            return res.status(409).json({
                success: false,
                error: 'User with this email already exists'
            });
        }

        const newId = Math.max(...users.map(u => u.id)) + 1;
        const newUser = { id: newId, name, age, email };
        
        users.push(newUser);
        
        res.status(201).json({
            success: true,
            message: 'User created successfully',
            data: newUser
        });
    } catch (error) {
        console.error('Create user error:', error);
        res.status(500).json({
            success: false,
            error: 'Failed to create user'
        });
    }
});

// PUT update user
app.put('/api/users/:id', validateUser, async (req, res) => {
    try {
        const id = parseInt(req.params.id);
        const userIndex = users.findIndex(u => u.id === id);

        if (userIndex === -1) {
            return res.status(404).json({
                success: false,
                error: 'User not found'
            });
        }

        const { name, age, email } = req.body;
        
        // Check email uniqueness (excluding current user)
        const emailExists = users.some(u => u.email === email && u.id !== id);
        if (emailExists) {
            return res.status(409).json({
                success: false,
                error: 'Email already in use by another user'
            });
        }

        users[userIndex] = { ...users[userIndex], name, age, email };

        res.json({
            success: true,
            message: 'User updated successfully',
            data: users[userIndex]
        });
    } catch (error) {
        console.error('Update user error:', error);
        res.status(500).json({
            success: false,
            error: 'Failed to update user'
        });
    }
});`
    },
    {
    tabTitle: "Postman",
    title: "Postman Setup & Usage",
    content: `/*
Why Postman?
• API Development & Testing
• Automated Testing Collections
• Environment Variables
• Team Collaboration
• Documentation Generation
• Mock Servers

Setup Steps:
1. Download & Install Postman
2. Create Workspace for your project
3. Set up Environment Variables:
   - base_url: http://localhost:4000
   - token: (for authentication later)
4. Create Collections for each resource (Users, Products, etc.)

Advanced Features:
• Pre-request Scripts (set variables, generate tokens)
• Tests (automated validation)
• Collection Runner (batch testing)
• Monitoring (scheduled API checks)

Example Test Script in Postman:
// Check status code is 200
pm.test("Status code is 200", function () {
    pm.response.to.have.status(200);
});

// Validate response structure
pm.test("Response has correct structure", function () {
    const response = pm.response.json();
    pm.expect(response).to.have.property('success', true);
    pm.expect(response).to.have.property('data');
});

Environment Variables Usage:
const baseUrl = pm.environment.get("base_url");
pm.sendRequest(\`\${baseUrl}/api/users\`, function (err, response) {
    console.log(response.json());
});
*/`},{
        tabTitle: "Plop.js",
        title: "Plop.js - Code Generation",
        content: `/*
Why Use Plop.js?
• Consistent code structure
• Time-saving automation
• Team standardization
• Reduced boilerplate code

Setup:
1. Install: npm install -D plop
2. Create plopfile.js in root directory
3. Define generators for common components

Example plopfile.js:
module.exports = function (plop) {
    // Controller generator
    plop.setGenerator('controller', {
        description: 'Create a new controller',
        prompts: [{
            type: 'input',
            name: 'name',
            message: 'Controller name (without "Controller" suffix):'
        }],
        actions: [{
            type: 'add',
            path: 'src/controllers/{{pascalCase name}}Controller.js',
            templateFile: 'plop-templates/controller.hbs'
        }]
    });

    // Route generator
    plop.setGenerator('route', {
        description: 'Create a new route file',
        prompts: [{
            type: 'input',
            name: 'name',
            message: 'Route name (plural):'
        }],
        actions: [{
            type: 'add',
            path: 'src/routes/{{lowerCase name}}.js',
            templateFile: 'plop-templates/route.hbs'
        }]
    });
};

Example controller template (plop-templates/controller.hbs):
class {{pascalCase name}}Controller {
    async getAll(req, res) {
        try {
            // TODO: Implement get all logic
            res.json({ success: true, data: [] });
        } catch (error) {
            console.error('Error in {{camelCase name}}Controller.getAll:', error);
            res.status(500).json({ success: false, error: 'Internal server error' });
        }
    }

    async getById(req, res) {
        try {
            const { id } = req.params;
            // TODO: Implement get by ID logic
            res.json({ success: true, data: { id } });
        } catch (error) {
            console.error('Error in {{camelCase name}}Controller.getById:', error);
            res.status(500).json({ success: false, error: 'Internal server error' });
        }
    }

    async create(req, res) {
        try {
            const data = req.body;
            // TODO: Implement create logic
            res.status(201).json({ success: true, data });
        } catch (error) {
            console.error('Error in {{camelCase name}}Controller.create:', error);
            res.status(500).json({ success: false, error: 'Internal server error' });
        }
    }

    async update(req, res) {
        try {
            const { id } = req.params;
            const data = req.body;
            // TODO: Implement update logic
            res.json({ success: true, data: { id, ...data } });
        } catch (error) {
            console.error('Error in {{camelCase name}}Controller.update:', error);
            res.status(500).json({ success: false, error: 'Internal server error' });
        }
    }

    async delete(req, res) {
        try {
            const { id } = req.params;
            // TODO: Implement delete logic
            res.json({ success: true, message: 'Deleted successfully' });
        } catch (error) {
            console.error('Error in {{camelCase name}}Controller.delete:', error);
            res.status(500).json({ success: false, error: 'Internal server error' });
        }
    }
}

module.exports = {{pascalCase name}}Controller;

Usage:
npx plop controller
# Enter: user
# Generates: UserController.js with all CRUD methods

Benefits:
• Standardized error handling
• Consistent method names
• Pre-built try-catch structure
• Team alignment
*/
`
    },
    {
        tabTitle: "Views & MVC Architecture",
        title: "Server-Side Rendering with Express Templates",
        content: `/*
MVC Architecture:
• Model: Data & business logic (Database models)
• View: Presentation layer (Templates)
• Controller: Handles requests & coordinates between Model and View

Express Template Engine Support:
• EJS (Embedded JavaScript) - HTML-like syntax (recommended for beginners)
• Pug (formerly Jade) - Indentation-based, concise syntax
• Handlebars - Mustache-like syntax with logic
• Nunjucks - Jinja2-inspired, powerful inheritance

Setup Steps for EJS:
*/

// 1. Install EJS
// npm install ejs

// 2. Configure Express to use EJS
const express = require('express');
const app = express();

// Set views directory and engine
app.set('views', './src/views'); 
app.set('view engine', 'ejs');

// 3. Serve static files (CSS, JS, images)
app.use(express.static('public'));

// 4. Create views structure:
// views/
//   ├── partials/
//   │   ├── header.ejs
//   │   ├── footer.ejs
//   │   ├── head.ejs
//   │   └── navigation.ejs
//   ├── pages/
//   │   ├── home.ejs
//   │   ├── users.ejs
//   │   └── products.ejs
//   └── layouts/
//       └── main.ejs

// Example EJS Layout (layouts/main.ejs)
<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head', { title: pageTitle || 'Default Title' }) %>
</head>
<body>
    <%- include('../partials/header') %>
    
    <main class="container">
        <%- body %>
    </main>

    <%- include('../partials/footer') %>
    
</body>
</html>

// Example partial (partials/head.ejs)
<\ meta charset="UTF-8">
<\ meta name="viewport" content="width=device-width, initial-scale=1.0">
<title><%= title %></title>
<link rel="stylesheet" href="/css/style.css">

// Example page template (pages/home.ejs)
<h1>Welcome to <%= appName %></h1>

<% if (userLoggedIn) { %>
    <div class="welcome-message">
        <p>Hello <strong><%= username %></strong>!</p>
        <a href="/dashboard" class="btn">Go to Dashboard</a>
    </div>
<% } else { %>
    <div class="auth-prompt">
        <p>Please log in to continue</p>
        <a href="/login" class="btn">Login</a>
        <a href="/register" class="btn btn-secondary">Register</a>
    </div>
<% } %>

<div class="products-grid">
    <h2>Featured Products</h2>
    <div class="products-list">
        <% products.forEach(product => { %>
            <div class="product-card">
                <h3><%= product.name %></h3>
                <p class="price">$<%= product.price.toFixed(2) %></p>
                <p class="description"><%= product.description %></p>
                <% if (product.onSale) { %>
                    <span class="sale-badge">On Sale!</span>
                <% } %>
            </div>
        <% }) %>
    </div>
</div>

// Controller rendering the view
app.get('/', (req, res) => {
    res.render('pages/home', {
        title: 'Home Page',
        appName: 'My Express Store',
        userLoggedIn: true,
        username: 'JohnDoe',
        products: [
            { 
                name: 'Gaming Laptop', 
                price: 1299.99, 
                description: 'High-performance gaming laptop',
                onSale: false
            },
            { 
                name: 'Wireless Mouse', 
                price: 29.99, 
                description: 'Ergonomic wireless mouse',
                onSale: true
            },
            { 
                name: 'Mechanical Keyboard', 
                price: 89.99, 
                description: 'RGB mechanical keyboard',
                onSale: false
            }
        ]
    });
});

// Advanced EJS Features:

// 1. Includes with parameters
<%- include('partials/product-card', { product: item, showDetails: true }) %>

// 2. Conditional rendering
<% if (user.role === 'admin') { %>
    <button class="admin-btn">Admin Panel</button>
<% } %>

// 3. Loops with index
<% users.forEach((user, index) => { %>
    <tr class="<%= index % 2 === 0 ? 'even' : 'odd' %>">
        <td><%= user.name %></td>
        <td><%= user.email %></td>
    </tr>
<% }) %>

// 4. Using JavaScript functions
<% const formatDate = (date) => new Date(date).toLocaleDateString(); %>
<p>Created: <%= formatDate(post.createdAt) %></p>

// For Handlebars users (alternative template engine):
// const hbs = require('hbs');
// hbs.registerHelper('uppercase', (str) => str.toUpperCase());
// hbs.registerHelper('eq', (a, b) => a === b);

// Usage in Handlebars: {{uppercase name}}

// Benefits of Server-Side Rendering:
// • SEO friendly
// • Fast initial page load
// • Consistent user experience
// • Better performance on low-powered devices
`
    },
    {
        tabTitle: "Database Fundamentals",
        title: "Database Systems",
        content: `/*Why Databases? (vs Arrays/Objects):
| Aspect               | In-Memory Storage          | Database Storage            |
|----------------------|----------------------------|----------------------------|
| Persistence          | ❌ Lost on restart         | ✅ Permanent storage       |
| Scalability          | ❌ Limited to RAM size     | ✅ Handles TB/PB of data   |
| Concurrent Access    | ❌ Single application      | ✅ Multiple applications   |
| Query Optimization   | ❌ Manual implementation   | ✅ Built-in optimization   |
| Data Integrity       | ❌ No transactions         | ✅ ACID transactions       |
| Backup & Recovery    | ❌ Manual backup needed    | ✅ Built-in solutions      |

Real-world Example:
// ❌ Volatile in-memory storage
let users = [
    {id: 1, name: "John", email: "john@example.com"},
    // ... 100,000 more users
];
// Data lost when server restarts!

// ✅ Persistent database storage
const users = await User.find({ 
    age: { $gte: 18 },
    status: 'active'
}).sort({ createdAt: -1 }).limit(50);
*/`},
    {
        tabTitle: "SQL vs NoSQL",
        title: "SQL vs NoSQL",
        content: `/*
| Aspect               | SQL Databases              | NoSQL Databases            |
|----------------------|----------------------------|----------------------------|
| Data Structure       | Table-based (Rows/Columns) | Document/Key-Value/Graph   |
| Schema               | ✅ Strict, predefined      | ✅ Flexible, dynamic       |
| Scaling              | ✅ Vertical scaling        | ✅ Horizontal scaling      |
| Transactions         | ✅ ACID compliance         | ✅ BASE principle          |
| Joins                | ✅ Native JOIN operations  | ❌ Manual references       |
| Examples             | MySQL, PostgreSQL          | MongoDB, Cassandra         |

When to Use Each:

SQL (Structured Data):
• Financial systems (banks, accounting)
• E-commerce platforms
• Applications requiring complex joins
• Data with strict relationships

NoSQL (Flexible Data):
• Real-time applications (chat, gaming)
• Content management systems
• IoT data processing
• Rapid prototyping
• Scalable web applications

Modern Approach: Polyglot Persistence
• Use SQL for transactional data
• Use NoSQL for content, logs, analytics
• Use Redis for caching
• Use Elasticsearch for search
*/`},{
    tabTitle: "MongoDB",
    title: "MongoDB Introduction",
    content: `/*MongoDB Features:
• Document-oriented NoSQL database
• BSON format (Binary JSON - extended data types)
• Horizontal scaling with sharding
• High availability with replica sets
• Flexible schema design
• Rich query language with aggregation
• Full-text search capabilities
• Geospatial queries

MongoDB Structure:
Database → Collections → Documents

Example Document:
{
    _id: ObjectId("507f1f77bcf86cd799439011"),
    title: "Understanding MongoDB",
    content: "Complete guide to MongoDB...",
    author: {
        name: "John Doe",
        email: "john@example.com"
    },
    tags: ["database", "mongodb", "nosql"],
    metadata: {
        views: 1500,
        likes: 42,
        published: true
    },
    createdAt: ISODate("2024-01-15T10:30:00Z"),
    updatedAt: ISODate("2024-01-20T14:45:00Z")
}

Collection: [documents...] (similar to SQL table)
Database: { collections... } (similar to SQL database)
*/
`
    },
    {
        tabTitle: "MongoDB Setup & Mongoose",
        title: "Database Configuration with MongoDB & Mongoose ODM",
        content: `/*
Option A: MongoDB Atlas (Cloud - Recommended for Production)
1. Create account at https://www.mongodb.com/cloud/atlas
2. Build a Cluster:
   - Choose cloud provider (AWS, Google Cloud, Azure)
   - Select region closest to your users
   - Choose M0 (Free tier) for development
3. Security Configuration:
   - Create database user with read/write privileges
   - Add IP whitelist: 0.0.0.0/0 (all IPs) for development
4. Get Connection String:
mongodb+srv://username:password@cluster0.xzyr.mongodb.net/databaseName?retryWrites=true&w=majority

Option B: Local Installation (Development)
1. Download MongoDB Community Server
2. Installation:
   - Windows: MSI installer with MongoDB Compass
   - macOS: brew install mongodb-community
   - Linux: apt-get install mongodb
3. Start MongoDB service
4. Connect: mongodb://localhost:27017/databaseName
*/

// ## MongoDB Compass GUI

/*
MongoDB Compass Features:
• Visual document explorer and editor
• Query performance analytics
• Index management and optimization
• Schema analysis and validation
• Aggregation pipeline builder
• Import/Export capabilities

Connection Strings:
• Local: mongodb://localhost:27017
• Atlas: mongodb+srv://username:password@cluster...
*/

// ## Mongoose ODM Setup

// 1. Installation: npm install mongoose

// 2. Database Connection Configuration
const mongoose = require('mongoose');

const connectDB = async () => {
    try {
        const conn = await mongoose.connect(process.env.MONGODB_URI, {
            // Note: useNewUrlParser and useUnifiedTopology are now default in Mongoose 6+
            // No need to specify them in newer versions
        });

        console.log(\`MongoDB Connected: \${conn.connection.host}\`);
    } catch (error) {
        console.error('Database connection error:', error);
        process.exit(1);
    }
};

// Modern connection event handling
mongoose.connection.on('connected', () => {
    console.log('Mongoose connected to MongoDB');
});

mongoose.connection.on('error', (err) => {
    console.error('Mongoose connection error:', err);
});

mongoose.connection.on('disconnected', () => {
    console.log('Mongoose disconnected');
});

// Graceful shutdown
process.on('SIGINT', async () => {
    await mongoose.connection.close();
    console.log('MongoDB connection closed due to app termination');
    process.exit(0);
});

// ## Mongoose Schema & Models

/*
Schema Definition Best Practices:
• Define data types and validation
• Set required fields appropriately
• Add indexes for frequently queried fields
• Use timestamps for audit trails
*/

const userSchema = new mongoose.Schema({
    name: { 
        type: String, 
        required: [true, 'Name is required'],
        trim: true,
        minlength: [2, 'Name must be at least 2 characters'],
        maxlength: [50, 'Name cannot exceed 50 characters']
    },
    email: {
        type: String,
        required: [true, 'Email is required'],
        unique: true,
        lowercase: true,
        validate: {
            validator: function(email) {
                return /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email);
            },
            message: 'Please provide a valid email address'
        }
    },
    age: {
        type: Number,
        min: [18, 'Age must be at least 18'],
        max: [120, 'Age cannot exceed 120']
    },
    role: {
        type: String,
        enum: ['user', 'admin', 'moderator'],
        default: 'user'
    },
    profile: {
        bio: String,
        avatar: String,
        website: String
    },
    preferences: {
        newsletter: { type: Boolean, default: true },
        notifications: { type: Boolean, default: true }
    }
}, {
    timestamps: true, // Adds createdAt and updatedAt automatically
    toJSON: { virtuals: true },
    toObject: { virtuals: true }
});

// Virtual properties (not stored in database)
userSchema.virtual('displayName').get(function() {
    return \`\${this.name} (\${this.email})\`;
});

// Instance methods
userSchema.methods.getProfileInfo = function() {
    return \`Name: \${this.name}, Email: \${this.email}, Role: \${this.role}\`;
};

// Static methods
userSchema.statics.findByEmail = function(email) {
    return this.findOne({ email: email.toLowerCase() });
};

// Middleware (pre and post hooks)
userSchema.pre('save', function(next) {
    console.log(\`Saving user: \${this.name}\`);
    next();
});

userSchema.post('save', function(doc, next) {
    console.log(\`User \${doc.name} saved successfully\`);
    next();
});

const User = mongoose.model('User', userSchema);

// ## CRUD Operations with Mongoose

// Create (Multiple ways)
const newUser = await User.create({
    name: 'Alice Johnson',
    email: 'alice@example.com',
    age: 28
});

// Or using save()
const user = new User({ name: 'Bob Smith', email: 'bob@example.com' });
await user.save();

// Read (Multiple query methods)
const allUsers = await User.find();
const adultUsers = await User.find({ age: { $gte: 18 } });
const specificUser = await User.findOne({ email: 'alice@example.com' });
const userById = await User.findById('507f1f77bcf86cd799439011');

// With projection (select specific fields)
const usersWithNames = await User.find({}, 'name email');

// With population (if there were references)
// const usersWithPosts = await User.find().populate('posts');

// Update
await User.updateOne(
    { _id: '507f1f77bcf86cd799439011' },
    { $set: { age: 30, name: 'Updated Name' } }
);

// Or using findOneAndUpdate (returns the document)
const updatedUser = await User.findOneAndUpdate(
    { email: 'alice@example.com' },
    { $inc: { age: 1 } }, // Increment age by 1
    { new: true } // Return updated document
);

// Delete
await User.deleteOne({ _id: '507f1f77bcf86cd799439011' });
await User.findOneAndDelete({ email: 'bob@example.com' });

module.exports = User;
`
    },
    {
        tabTitle: "Advanced Express Features",
        title: "Production-Ready Express Applications",
        content: `/*
Production Best Practices:
• Environment configuration
• Security headers
• Rate limiting
• Request sanitization
• Proper error handling
• Logging
• Performance optimization
*/

const cors = require('cors');
const helmet = require('helmet');
const rateLimit = require('express-rate-limit');
const compression = require('compression');

// Security middleware
app.use(helmet({
    contentSecurityPolicy: {
        directives: {
            defaultSrc: ["'self'"],
            styleSrc: ["'self'", "'unsafe-inline'"],
            scriptSrc: ["'self'"],
            imgSrc: ["'self'", "data:", "https:"],
        },
    },
    crossOriginEmbedderPolicy: false
}));

// CORS configuration
app.use(cors({
    origin: process.env.ALLOWED_ORIGINS?.split(',') || ['http://localhost:3000'],
    credentials: true
}));

// Rate limiting
const limiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 minutes
    max: 100, // limit each IP to 100 requests per windowMs
    message: {
        error: 'Too many requests from this IP, please try again later.'
    }
});
app.use('/api/', limiter);

// Compression
app.use(compression());

// Environment-based configuration
const config = {
    development: {
        port: 4000,
        host: 'localhost',
        logLevel: 'debug'
    },
    production: {
        port: process.env.PORT || 80,
        host: '0.0.0.0',
        logLevel: 'warn'
    }
};

const environment = process.env.NODE_ENV || 'development';
const currentConfig = config[environment];

// Advanced error handling
class AppError extends Error {
    constructor(message, statusCode) {
        super(message);
        this.statusCode = statusCode;
        this.isOperational = true;
        Error.captureStackTrace(this, this.constructor);
    }
}

// Async error wrapper (avoid try-catch in every route)
const asyncHandler = (fn) => (req, res, next) => {
    Promise.resolve(fn(req, res, next)).catch(next);
};

// Example with async handler
app.get('/api/async-users', asyncHandler(async (req, res) => {
    // Simulate async operation
    const users = await Promise.resolve([...users]);
    res.json({ success: true, data: users });
}));

// Global error handler
app.use((err, req, res, next) => {
    err.statusCode = err.statusCode || 500;
    err.status = err.status || 'error';

    if (process.env.NODE_ENV === 'development') {
        res.status(err.statusCode).json({
            status: err.status,
            error: err,
            message: err.message,
            stack: err.stack
        });
    } else {
        // Production: don't leak error details
        if (err.isOperational) {
            res.status(err.statusCode).json({
                status: err.status,
                message: err.message
            });
        } else {
            console.error('ERROR 💥', err);
            res.status(500).json({
                status: 'error',
                message: 'Something went wrong!'
            });
        }
    }
});

// Graceful shutdown
process.on('SIGTERM', () => {
    console.log('SIGTERM received. Shutting down gracefully...');
    server.close(() => {
        console.log('Process terminated');
    });
});`
    }
];

// Enhanced Questions and Tasks with new content
const questions = [
    // Development Tools
    {
        type: "question",
        question: "What is the primary purpose of using Postman in API development?",
        options: [
            "To write backend code faster",
            "To test, document, and debug APIs with a graphical interface",
            "To deploy applications to production",
            "To generate database schemas automatically"
        ],
        correctIndex: 1
    },
    {
        type: "question",
        question: "Why is Plop.js typically installed as a devDependency?",
        options: [
            "Because it's only used during development for code generation",
            "Because it's too large for production environments",
            "Because it conflicts with Express.js in production",
            "Because it requires special permissions to run"
        ],
        correctIndex: 0
    },
    {
        type: "question",
        question: "Which Postman feature allows you to store variables like base URLs and authentication tokens?",
        options: [
            "Collections",
            "Environments",
            "Workspaces", 
            "Tests"
        ],
        correctIndex: 1
    },

    // Views & MVC
    {
        type: "question",
        question: "In the MVC architecture, what is the responsibility of the View layer?",
        options: [
            "Handle business logic and data processing",
            "Manage database connections and queries",
            "Present data to the user and handle user interface",
            "Process HTTP requests and responses"
        ],
        correctIndex: 2
    },
    {
        type: "question",
        question: "Which Express method is used to serve static files like CSS and JavaScript?",
        options: [
            "app.set()",
            "app.use() with express.static()",
            "app.render()",
            "app.sendFile()"
        ],
        correctIndex: 1
    },
    {
        type: "question",
        question: "What is the main advantage of using template engines like EJS over sending plain HTML?",
        options: [
            "They make websites load faster",
            "They allow dynamic content rendering with JavaScript",
            "They reduce the amount of CSS needed",
            "They automatically optimize images"
        ],
        correctIndex: 1
    },

    // Database Fundamentals
    {
        type: "question",
        question: "What is the key difference between SQL and NoSQL databases regarding schema?",
        options: [
            "SQL databases have flexible schemas, NoSQL have rigid schemas",
            "SQL databases have rigid schemas, NoSQL have flexible schemas", 
            "Both have exactly the same schema approach",
            "NoSQL databases don't support any schema"
        ],
        correctIndex: 1
    },
    {
        type: "question",
        question: "In MongoDB, what is the equivalent of a 'table' in SQL databases?",
        options: [
            "Document",
            "Collection",
            "Database",
            "Field"
        ],
        correctIndex: 1
    },
    {
        type: "question",
        question: "Which MongoDB feature allows distributing data across multiple servers for horizontal scaling?",
        options: [
            "Replication",
            "Sharding",
            "Indexing",
            "Aggregation"
        ],
        correctIndex: 1
    },

    // Mongoose & ODM
    {
        type: "question",
        question: "What is the purpose of Mongoose in a Node.js application?",
        options: [
            "To generate HTML templates",
            "To provide an Object Data Modeling (ODM) library for MongoDB",
            "To handle HTTP requests and routing",
            "To compile Sass stylesheets"
        ],
        correctIndex: 1
    },
    {
        type: "question",
        question: "In Mongoose, what does the 'timestamps' option in a schema automatically add?",
        options: [
            "createdAt and updatedAt fields",
            "id and _id fields", 
            "version and revision fields",
            "status and active fields"
        ],
        correctIndex: 0
    },
    {
        type: "question",
        question: "Which method is used in Mongoose to find a single document by its ID?",
        options: [
            "findOne()",
            "findById()",
            "find().byId()",
            "getById()"
        ],
        correctIndex: 1
    },

    // Project Structure & Organization
    {
        type: "question",
        question: "What is the main benefit of organizing code into controllers, routes, and models?",
        options: [
            "It makes the code run faster",
            "It improves code organization and separation of concerns",
            "It reduces the number of files",
            "It eliminates the need for documentation"
        ],
        correctIndex: 1
    },

    // Middleware & Error Handling
    {
        type: "question",
        question: "What is the purpose of using try-catch blocks in controller methods?",
        options: [
            "To make code run faster",
            "To handle synchronous and asynchronous errors gracefully",
            "To reduce code length",
            "To automatically log all requests"
        ],
        correctIndex: 1
    },

    // Practical Tasks - Development Tools
    {
        type: "task",
        title: "Postman Collection Setup",
        content: "Create a comprehensive Postman collection for testing a REST API. Include environments for development and production, write test scripts for each endpoint, create pre-request scripts for authentication, and document all API endpoints with examples and descriptions."
    },
    {
        type: "task",
        title: "Plop.js Code Generator",
        content: "Set up Plop.js in your project and create generators for controllers, routes, models, and middleware. Each generator should include proper error handling, validation, and follow your project's coding standards. Test the generators by creating multiple components."
    },

    // Practical Tasks - Views & MVC
    {
        type: "task",
        title: "EJS Template Implementation",
        content: "Create a complete EJS template structure for a blog application. Include layouts, partials for header/footer/navigation, and dynamic pages for home, blog posts, and user profiles. Implement conditionals, loops, and template inheritance. Add static file serving for CSS and JavaScript."
    },
    {
        type: "task", 
        title: "MVC Architecture Implementation",
        content: "Build a complete MVC application with Express.js and EJS. Create models for users and posts, controllers to handle business logic, and views to render the data. Implement full CRUD operations and ensure proper separation of concerns between the layers."
    },

    // Practical Tasks - Database & MongoDB
    {
        type: "task",
        title: "MongoDB Atlas Setup & Connection",
        content: "Set up a MongoDB Atlas cluster, configure database access and network security, establish connection from your Express application using Mongoose, and implement proper error handling for connection issues. Create environment variables for sensitive data."
    },
    {
        type: "task",
        title: "Mongoose Schema Design",
        content: "Design and implement comprehensive Mongoose schemas for a e-commerce application including users, products, orders, and categories. Add validation, virtual properties, instance methods, static methods, and middleware. Create relationships between collections using references."
    },

    // Practical Tasks - Express.js
    {
        type: "task",
        title: "Complete REST API Implementation",
        content: "Build a complete REST API for a 'products' resource with full CRUD operations. Include input validation, proper HTTP status codes, error handling with try-catch, and implement filtering, sorting, and pagination for the GET endpoints."
    },
    {
        type: "task", 
        title: "API Security Implementation",
        content: "Secure your Express application by implementing CORS, Helmet for security headers, input sanitization, and parameter validation. Add rate limiting and implement proper authentication using JWT tokens with environment variables for secrets."
    },

    // Search & Research Tasks
    {
        type: "search-task",
        title: "Research: SQL vs NoSQL Deep Dive",
        content: "Research and create a comprehensive comparison between SQL and NoSQL databases. Include performance benchmarks for different use cases, scalability considerations, consistency models, and real-world implementation examples. Create a decision framework for choosing between SQL and NoSQL."
    },
    {
        type: "search-task",
        title: "Research: Express.js Best Practices",
        content: "Research and document Express.js best practices for production applications. Include topics like project structure, environment configuration, performance optimization, security practices, and deployment strategies. Create a checklist for production-ready Express applications."
    },
    {
        type: "search-task",
        title: "Advanced: API Testing Strategies",
        content: "Research different API testing approaches and tools. Compare Postman, Thunder Client, Jest for API testing, and automated testing strategies. Create a comprehensive testing suite for an Express API including unit tests, integration tests, and end-to-end tests."
    },

    // Debugging & Problem Solving
    {
        type: "task",
        title: "Database Connection Debugging",
        content: "Debug common MongoDB connection issues including authentication failures, network timeouts, and configuration problems. Implement proper connection error handling, retry logic, and connection status monitoring in your application."
    },
    {
        type: "task",
        title: "Template Engine Debugging",
        content: "Identify and fix common EJS template issues including variable rendering problems, partial includes not working, conditional logic errors, and static file serving issues. Implement proper error boundaries and template validation."
    },
    {
        type: "task",
        title: "Performance Optimization",
        content: "Analyze an existing Express application for performance bottlenecks. Implement compression, caching strategies, database optimization, and proper error handling. Use tools to monitor and improve application performance."
    },

    // Integration Tasks
    {
        type: "task",
        title: "Full Stack Integration Project",
        content: "Build a complete full-stack application integrating all concepts: Express.js backend with MVC architecture, MongoDB database with Mongoose ODM, EJS templates for server-side rendering, and Postman for API testing. Implement user authentication, CRUD operations, and proper error handling throughout the stack."
    },
    {
        type: "task",
        title: "Production Deployment Preparation",
        content: "Prepare your Express application for production deployment. Configure environment variables, set up logging, implement health check endpoints, configure reverse proxy settings, create Docker containers, and set up continuous integration/deployment pipelines."
    }
];      
        // Set lecture title and subtitle
        document.getElementById('lecture-title').textContent = lectureConfig.title;
        document.getElementById('lecture-subtitle').textContent = lectureConfig.subtitle;
        
        // Render tabs and content
        function renderTabsAndContent() {
            const tabsContainer = document.getElementById('tabs-container');
            const contentContainer = document.getElementById('tab-content-container');
            
            // Create tabs
            const tabs = document.createElement('div');
            tabs.className = 'tabs';
            
            // Create tab content areas
            lectureContent.forEach((content, index) => {
                // Create tab
                const tab = document.createElement('div');
                tab.className = 'tab' + (index === 0 ? ' active' : '');
                tab.textContent = content.tabTitle;
                tab.onclick = () => switchTab(index);
                tabs.appendChild(tab);
                
                // Create content
                const tabContent = document.createElement('div');
                tabContent.className = 'tab-content' + (index === 0 ? ' active' : '');
                tabContent.id = 'tab-' + index;
                
                // Add title
                const title = document.createElement('h3');
                title.textContent = content.title;
                tabContent.appendChild(title);
                
                // Add code content
                const pre = document.createElement('pre');
                const code = document.createElement('code');
                code.textContent = content.content;
                pre.appendChild(code);
                tabContent.appendChild(pre);

                // Add table if exists
                if (content.table) {
                    const table = document.createElement('table');
                    table.className = 'comparison-table';
                    
                    // Create header
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    content.table.headers.forEach(headerText => {
                        const th = document.createElement('th');
                        th.textContent = headerText;
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    table.appendChild(thead);
                    
                    // Create body
                    const tbody = document.createElement('tbody');
                    content.table.rows.forEach(rowData => {
                        const row = document.createElement('tr');
                        rowData.forEach(cellData => {
                            const td = document.createElement('td');
                            td.textContent = cellData;
                            row.appendChild(td);
                        });
                        tbody.appendChild(row);
                    });
                    table.appendChild(tbody);
                    
                    tabContent.appendChild(table);
                }
                
                
                contentContainer.appendChild(tabContent);
            });
            
            tabsContainer.appendChild(tabs);
        }
        
        // Switch tabs function
        function switchTab(index) {
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Add active class to clicked tab
            tabs[index].classList.add('active');
            
            // Hide all tab content
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById('tab-' + index).classList.add('active');
        }
        
        // Render questions and tasks
        function renderQuestions() {
            const container = document.getElementById('questions-container');
            
            questions.forEach((q, index) => {
                if (q.type === 'question') {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'question';
                    
                    const questionTitle = document.createElement('h3');
                    questionTitle.textContent = `Question ${index + 1}: ${q.question}`;
                    questionDiv.appendChild(questionTitle);
                    
                    if (q.code) {
                        const pre = document.createElement('pre');
                        const code = document.createElement('code');
                        code.textContent = q.code;
                        pre.appendChild(code);
                        questionDiv.appendChild(pre);
                    }
                    
                    const optionsDiv = document.createElement('div');
                    optionsDiv.className = 'options';
                    
                    q.options.forEach((option, optIndex) => {
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'option';
                        optionDiv.textContent = option;
                        optionDiv.onclick = function() {
                            checkAnswer(this, optIndex === q.correctIndex ? 'correct' : 'incorrect');
                        };
                        optionsDiv.appendChild(optionDiv);
                    });
                    
                    questionDiv.appendChild(optionsDiv);
                    
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'result';
                    resultDiv.id = 'result-' + index;
                    questionDiv.appendChild(resultDiv);
                    
                    container.appendChild(questionDiv);
                } else if (q.type === 'task') {
                    const taskDiv = document.createElement('div');
                    taskDiv.className = 'task';
                    
                    const taskTitle = document.createElement('h3');
                    taskTitle.textContent = q.title;
                    taskDiv.appendChild(taskTitle);
                    
                    const taskContent = document.createElement('p');
                    taskContent.textContent = q.content;
                    taskDiv.appendChild(taskContent);
                    
                    container.appendChild(taskDiv);
                } else if (q.type === 'search-task') {
                    const searchTaskDiv = document.createElement('div');
                    searchTaskDiv.className = 'search-task';
                    
                    const taskTitle = document.createElement('h3');
                    taskTitle.textContent = q.title;
                    searchTaskDiv.appendChild(taskTitle);
                    
                    const taskContent = document.createElement('p');
                    taskContent.textContent = q.content;
                    searchTaskDiv.appendChild(taskContent);
                    
                    container.appendChild(searchTaskDiv);
                }
            });
        }
        
        // Check answer function
        function checkAnswer(element, type) {
            const options = element.parentElement.querySelectorAll('.option');
            options.forEach(opt => {
                opt.classList.remove('correct', 'incorrect');
                opt.onclick = null;
            });
            
            element.classList.add(type);
            
            const resultId = element.closest('.question').querySelector('.result').id;
            const resultDiv = document.getElementById(resultId);
            resultDiv.style.display = 'block';
            
            if (type === 'correct') {
                resultDiv.innerHTML = '<p style="color: #155724">✅ Correct! Good job.</p>';
                resultDiv.style.backgroundColor = '#d4edda';
            } else {
                resultDiv.innerHTML = '<p style="color: #721c24">❌ Incorrect. Try to understand why.</p>';
                resultDiv.style.backgroundColor = '#f8d7da';
            }
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            renderTabsAndContent();
            renderQuestions();
        });
    </script>
</body>
</html>